on:
  workflow_call:
  workflow_dispatch:
  pull_request:

env:
  FORCE_COLOR: 2

jobs:
  format:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python and install dependencies
        uses: ./.github/actions/setup-python

      - name: Format with black
        run: |
          uv run black --check .

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python and install dependencies
        uses: ./.github/actions/setup-python

      - name: Lint with ruff
        run: uv run ruff check .

  typecheck-ceda-usa:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python and install dependencies
        uses: ./.github/actions/setup-python

      - name: Typecheck w/ mypy
        run: uv run mypy bedrock/extract/iot

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python and install dependencies
        uses: ./.github/actions/setup-python

      - name: Authenticate with Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: cornerstone-data
          workload_identity_provider: projects/75718421862/locations/global/workloadIdentityPools/github-actions/providers/github
          service_account: github-actions-cornerstone@cornerstone-data.iam.gserviceaccount.com

      - name: Run tests
        run: |
          uv run pytest
