from __future__ import annotations

import pandas as pd

from bedrock.utils.taxonomy.bea.ceda_v7 import CEDA_V7_SECTORS
from bedrock.utils.economic.units import MEGATONNE_TO_KG
from bedrock.extract.allocation.bea import load_bea_use_table
from bedrock.extract.allocation.epa import load_mmt_co2e_across_fuel_types

ALLOCATION_SECTORS = [
    "221300",
    "423100",
    "423400",
    "423600",
    "423800",
    "423A00",
    "424200",
    "424400",
    "424700",
    "424A00",
    "425000",
    "4200ID",
    "441000",
    "445000",
    "452000",
    "444000",
    "446000",
    "447000",
    "448000",
    "454000",
    "4B0000",
    "493000",
    "511110",
    "511120",
    "511130",
    "5111A0",
    "511200",
    "512100",
    "512200",
    "515100",
    "515200",
    "517110",
    "517210",
    "517A00",
    "518200",
    "519130",
    "5191A0",
    "522A00",
    "52A000",
    "523900",
    "523A00",
    "524113",
    "5241XX",
    "524200",
    "525000",
    "531HSO",
    "531HST",
    "531ORE",
    "532100",
    "532400",
    "532A00",
    "533000",
    "541100",
    "541511",
    "541512",
    "54151A",
    "541200",
    "541300",
    "541610",
    "5416A0",
    "541700",
    "541800",
    "541400",
    "541920",
    "541940",
    "5419A0",
    "550000",
    "561300",
    "561700",
    "561100",
    "561200",
    "561400",
    "561500",
    "561600",
    "561900",
    "562000",
    "611100",
    "611A00",
    "611B00",
    "621100",
    "621200",
    "621300",
    "621400",
    "621500",
    "621600",
    "621900",
    "622000",
    "623A00",
    "623B00",
    "624100",
    "624400",
    "624A00",
    "711100",
    "711200",
    "711500",
    "711A00",
    "712000",
    "713100",
    "713200",
    "713900",
    "721000",
    "722110",
    "722211",
    "722A00",
    "811100",
    "811200",
    "811300",
    "811400",
    "812100",
    "812200",
    "812300",
    "812900",
    "813100",
    "813A00",
    "813B00",
    "814000",
    "S00102",
    "GSLGE",
    "GSLGH",
]


def allocate_commercial_coal() -> pd.Series[float]:
    emissions = load_mmt_co2e_across_fuel_types().loc["Total Coal", "Comm"]
    assert isinstance(emissions, float)

    pct = load_bea_use_table().loc[
        pd.Index(ALLOCATION_SECTORS), "212100"
    ]  # Coal Mining
    pct = pct / pct.sum()

    allocated = emissions * pct
    return allocated.reindex(CEDA_V7_SECTORS, fill_value=0.0) * MEGATONNE_TO_KG
